---
# Role to deploy an Okapi server from source to a Debian Jessie box
- name: Install prereqs
  become: yes
  apt: name={{ item }} state=present
  with_items:
    - git
    - curl

- name: Clone Okapi repository
  become: yes
  git: repo=https://github.com/folio-org/okapi.git dest={{ okapi_src_home }}

- name: Build Okapi
  become: yes
  shell: /usr/bin/mvn install > install.log
  args:
    chdir: "{{ okapi_src_home }}"
    creates: "{{ okapi_src_home }}/okapi-core/target"  

- name: Set up Okapi home directory
  become: yes
  file: state=directory path={{ item }}
  with_items:
    - /opt/okapi/lib
    - /opt/okapi/conf
    - /opt/okapi/logs

- name: Link in Okapi jar
  become: yes
  file: state=link src={{ okapi_src_home }}/okapi-core/target/okapi-core-fat.jar path={{ okapi_home }}/lib/okapi-core-fat.jar

# Temporary hack until init files are available
- name: Check if Okapi core is running
  become: yes
  shell: netstat -anp | grep 9130 | grep LISTEN
  register: okapi_check
  ignore_errors: yes
  changed_when: no

- name: Launch okapi-core
  become: yes
  shell: nohup java -jar -Dloglevel=DEBUG {{ okapi_home }}/lib/okapi-core-fat.jar dev > {{ okapi_home }}/logs/okapi.log &
  when: okapi_check.stdout.find('java') == -1
  register: okapi_launch

- name: Give Okapi a chance to spin up
  pause: seconds=5
  when: okapi_launch.changed == true
